<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Profil - Der Die Das Space">
  <title>Profil - Der Die Das Space</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/difficulty-badges.css">
  <link rel="stylesheet" href="css/pages.css">
  <link rel="stylesheet" href="css/responsive.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/images/favicon.png">
</head>
<body>
  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <nav class="navbar">
        <a href="index.html" class="navbar-brand">
          <span class="brand-name"><span style="color: #0099FF;">der</span><span style="color: #FF5C6E;">die</span><span style="color: #FFCC00;">das</span></span>
        </a>
        
        <div class="navbar-actions">
          <div class="language-selector">
            <button id="langTr" class="btn btn-sm" data-lang="tr">TR</button>
            <button id="langEn" class="btn btn-sm" data-lang="en">EN</button>
          </div>
          
          <a href="index.html" class="btn btn-sm" data-i18n="home">Ana Sayfa</a>
          <button id="logoutBtn" class="btn btn-sm btn-secondary" data-i18n="logout">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- Profile Header -->
      <section class="profile-header">
        <div class="card">
          <div class="card-body">
            <h1 id="profileName">ğŸ‘¤ KullanÄ±cÄ±</h1>
            
            <div class="user-stats">
              <div class="stat-item">
                <span class="stat-icon">ğŸ†</span>
                <span class="stat-label" data-i18n="totalScore">Toplam Skor:</span>
                <span id="totalScore" class="stat-value">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">ğŸ“Š</span>
                <span class="stat-label" data-i18n="globalRank">Global SÄ±ra:</span>
                <span id="globalRank" class="stat-value">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">ğŸ¯</span>
                <span class="stat-label" data-i18n="completedSets">Tamamlanan Set:</span>
                <span id="completedSets" class="stat-value">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">ğŸ®</span>
                <span class="stat-label" data-i18n="remainingSets">Kalan Set:</span>
                <span id="remainingSets" class="stat-value">-</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Badge Collection -->
      <section class="badge-section">
        <h2 data-i18n="badgeCollection">ğŸ–ï¸ Badge Koleksiyonu</h2>
        <p id="badgeCount" class="text-secondary">0/50 Badge KazandÄ±n</p>
        <p class="text-secondary">
          <a href="badges.html" data-i18n="viewAllBadges">TÃ¼m badge'leri gÃ¶r â†’</a>
        </p>
        
        <div id="badgeGrid" class="badge-grid">
          <!-- Badges will be inserted here -->
        </div>
      </section>

      <!-- Referral Section -->
      <section class="referral-section">
        <div class="card">
          <div class="card-body">
            <h3 data-i18n="inviteFriends">ğŸ“± ArkadaÅŸlarÄ±nÄ± Davet Et</h3>
            
            <div class="referral-code-container">
              <label data-i18n="yourReferralCode">Referral Kodun:</label>
              <div class="referral-code-input">
                <input type="text" id="referralCode" readonly>
                <button id="copyReferralBtn" class="btn btn-sm" data-i18n="copy">ğŸ“‹ Kopyala</button>
              </div>
            </div>
            
            <button id="whatsappShareBtn" class="btn btn-primary btn-block" data-i18n="shareWhatsApp">
              ğŸ“± WhatsApp ile PaylaÅŸ
            </button>
            
            <div class="referral-stats">
              <p>
                <span data-i18n="invited">Davet Ettin:</span>
                <span id="invitedCount">0</span>
                <span>|</span>
                <span data-i18n="pointsEarned">+<span id="referralPoints">0</span> puan</span>
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Game Statistics -->
      <section class="game-stats-section">
        <h2 data-i18n="gameStatistics">ğŸ“Š Oyun Ä°statistikleri</h2>
        
        <div id="gameStatsGrid" class="stats-grid">
          <!-- Game stats will be inserted here -->
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="page-footer">
    <div class="container">
      <div class="footer-content">
        <p>&copy; 2026 Der Die Das Space. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
        <nav class="footer-nav">
          <a href="leaderboard.html" data-i18n="leaderboard">Skor Tablosu</a>
          <a href="badges.html" data-i18n="badges">Badge'ler</a>
        </nav>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="js/core/i18n.js"></script>
  <script type="module" src="js/components/language-selector.js"></script>
  <script type="module" src="js/core/supabase.js"></script>
  <script type="module" src="js/core/auth.js"></script>
  <script type="module" src="js/core/referral.js"></script>
  <script type="module">
    import { getCurrentUser, logout } from './js/core/auth.js';
    import { getSupabase } from './js/core/supabase.js';
    import { t, getCurrentLanguage } from './js/core/i18n.js';
    import { shareOnWhatsApp, copyReferralLink, generateReferralCode } from './js/core/referral.js';

    // Check authentication
    document.addEventListener('DOMContentLoaded', async () => {
      const user = await getCurrentUser();
      if (!user) {
        window.location.href = 'index.html?showLogin=true';
        return;
      }

      // Load user profile
      await loadUserProfile(user.id);
      await loadUserBadges(user.id);
      await loadGameStats(user.id);
    });

    async function loadUserProfile(userId) {
      const supabase = getSupabase();
      if (!supabase) return;

      // Load profile data
      const { data: userData } = await supabase
        .from('users')
        .select('display_name, email')
        .eq('id', userId)
        .single();

      if (userData) {
        document.getElementById('profileName').textContent = `ğŸ‘¤ ${userData.display_name || userData.email}`;
      }

      // Generate and display referral code
      const referralCode = generateReferralCode(userId);
      const referralInput = document.getElementById('referralCode');
      if (referralInput) {
        referralInput.value = referralCode;
      }

      // Load stats
      const { data: scores } = await supabase
        .from('user_game_sets')
        .select('set_score, normalized_score')
        .eq('user_id', userId);

      if (scores && scores.length > 0) {
        const totalScore = scores.reduce((sum, s) => sum + s.set_score, 0);
        document.getElementById('totalScore').textContent = totalScore.toLocaleString();
        document.getElementById('completedSets').textContent = scores.length;
      }
    }

    async function loadUserBadges(userId) {
      const supabase = getSupabase();
      if (!supabase) return;

      const { data: badges } = await supabase
        .from('user_badges')
        .select(`
          badges (*)
        `)
        .eq('user_id', userId);

      const badgeGrid = document.getElementById('badgeGrid');
      if (badges && badges.length > 0) {
        document.getElementById('badgeCount').textContent = `${badges.length}/50 Badge KazandÄ±n`;
        badges.forEach(badge => {
          const badgeCard = createBadgeCard(badge.badges, true);
          badgeGrid.appendChild(badgeCard);
        });
      }
    }

    function createBadgeCard(badge, unlocked) {
      const card = document.createElement('div');
      card.className = `badge-card ${unlocked ? 'badge-card--unlocked' : 'badge-card--locked'}`;
      card.innerHTML = `
        <div class="badge-icon">${badge.icon_url || 'ğŸ–ï¸'}</div>
        <div class="badge-name">${badge.badge_name_tr || badge.badge_name_en}</div>
        ${unlocked ? '' : '<div class="badge-locked">ğŸ”’</div>'}
      `;
      return card;
    }

    async function loadGameStats(userId) {
      const supabase = getSupabase();
      if (!supabase) return;

      // Load game-specific statistics
      const { data: stats } = await supabase
        .from('user_game_sets')
        .select(`
          game_type_id,
          game_types (game_name_tr, game_name_en)
        `)
        .eq('user_id', userId);

      // Group by game type
      // Implementation here
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Logout button
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        await logout();
        window.location.href = 'index.html';
      });

      // Copy referral code
      document.getElementById('copyReferralBtn')?.addEventListener('click', async () => {
        const referralInput = document.getElementById('referralCode');
        if (referralInput && referralInput.value) {
          const success = await copyReferralLink(referralInput.value);
          if (success) {
            alert(t('copied') || 'KopyalandÄ±!');
          }
        }
      });

      // WhatsApp share
      document.getElementById('whatsappShareBtn')?.addEventListener('click', async () => {
        const user = await getCurrentUser();
        if (user) {
          const supabase = getSupabase();
          const referralCode = generateReferralCode(user.id);
          const { data: userData } = await supabase.from('users').select('display_name').eq('id', user.id).single();
          const displayName = userData?.display_name || 'Ben';
          shareOnWhatsApp(referralCode, displayName);
        }
      });
    });
  </script>
</body>
</html>


